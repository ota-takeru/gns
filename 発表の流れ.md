## ニューラルネットワークとは

入力に対して期待される出力を返すように関数の形を学習する仕組み。
[mlp の図を入れる]
特徴量、潜在ベクトルなどの説明も入れる

## gns(graph network based simulators)とは

水や砂、布などの異なる種類の物質が同時に存在する空間において物質を粒子の集まりとしてとらえ、粒子同士の相互作用をニューラルネットワークで学習することで物質の動きを予測する手法。

### 具体的なモデル構造

[図を入れる]

各時間ステップに対して以下の処理を行う。  
**encoder**  
各ノードに対して、近傍のノード間にエッジを張る。  
ノードとエッジの特徴量(速度、相対位置、物質の種類など)を MLP で潜在ベクトルに変換する。  
この変換によって同じ形になるので扱いやすくなる。<!-- 説明不足 -->
**processor**

- 各エッジを自身のエッジと、接続しているノードを入力として mlp で更新する。  
  エッジに粒子同士がどのような関係性なのかが反映される。
- 次に、各ノードを自身のノードと、接続している更新されたエッジを入力として mlp で更新する。  
 エッジの関係性をもとにノードの情報が更新される。

この操作を複数回繰り返すことでより遠くの粒子の情報も取り込むことができる。
**decoder**  
MLP を使って各ノードのベクトルを加速度に変換する.
**学習**  
出力された加速度と正解の加速度の差が小さくなるよう学習する。

**推論**
学習したモデルを用いて、出力した加速度から次の時間ステップの位置と速度を計算する。

### gns の課題

従来のニューラルネットワークベースのものに比べて精度と汎化が良い一方で、長い時間予測(ロールアウト）すると、誤差が含まれた出力が次の入力になるので誤差が蓄積していく。

gns の課題であるロールアウトによる誤差の蓄積を解決するために新しい手法を考える。

## 仮説

今回の gns の出力では加速度を直接予測している。
一方で実際の物理現象では力は保存力と散逸に分けられる。  
保存力は位置や密度に依存し、エネルギー保存則に従う。  
散逸は速度に依存し、エネルギーを減少させる方向に働く。
保存力と散逸を別々に学習することで、物理的な制約を加え、長期のロールアウトによる誤差の蓄積を抑えることができると考える。

## 対象とする物質

今回は対象を絞るために水を想定した流体のみを扱う。
教師データの作成には gns と同じように、流体を粒子の集合として扱う sph 法を採用する。

### 具体的な手法

流体力学において以下の基礎方程式について解く必要がある。  
[式を書く]  
連続の式(密度に関する式)
運動方程式(加速度の式)
状態方程式（圧力の式）  
圧力は扱う流体によって異なる定義がある。今回は水に近い非圧縮流体を考える。

sph 法は密度、加速度、圧力を以下のように近似する。
[式を書く]
密度の定義
運動方程式の定義
圧力の定義

これは流体力学の基礎方程式に対して、カーネル近似と積分の離散化を行った形と一致している。

流体でも保存力と散逸があることを説明する。

## 提案する手法

gns と同じ構造を用いてポテンシャルエネルギーと、散逸による加速度を別々に出力する。  
水を想定して弱圧縮流体を扱う。

$$
U(X) = \sum_{i,j} f_{\theta} (x_i, x_j) + g
$$

$$
a_{i保存} = - \nabla_{x_i} U(X) / m_i
$$

$$
F_{i} = \sum_{j\in 近傍} h_{\theta}(v_i - v_j)
$$

$$
a_{i散逸} = F_{i}/m_i
$$

**保存力**
位置を引数にポテンシャルエネルギーを出力する。  
出力されたポテンシャルエネルギーを各方向成分に対して偏微分することで加速度を求める。  
ポテンシャルエネルギーの計算はニューラルネットワークの関数とみることができて、pytorch の自動微分を用いて偏微分を計算する。  
**散逸**
相対速度を引数に散逸による加速度を出力する。
散逸による加速度は運動エネルギーが増えないように設計する。

そのあとは、加速度を合計して gns と同じように学習を進める。

ポテンシャルエネルギーから偏微分できるものだけに限定されるので、仮説空間を狭めることができる。  
自由度をポテンシャルエネルギーと散逸それぞれで制限しつつ、エネルギーが勝手に作られないようにすることで、長期のロールアウト誤差の減少が期待できる。

### 結果

元論文の gns と比較する。  
1 ステップとロールアウトの誤差を比べる。  
横軸タイムステップ、縦軸位置誤差。
パラメータ数や計算量をそろえる。  
保存力と散逸部分の加速度を教師データと比較してちゃんとバイアスが効いているか確かめる。  
散逸によって減るエネルギーを考慮して総エネルギーが増減しないか確かめる。

### 今後の課題

流体だけ扱ったので複数の物質をどこまで扱えるのか。
計算時間の短縮。
