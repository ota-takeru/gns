# 追記：保存力ブランチ（1）と自動微分（2）に関する明記（v1.0 追加仕様）

本追記は、保存力ブランチが「勾配由来の内部相互作用」として機能すること、
および自動微分による力計算を実装上破綻なく成立させることを目的とする。

---

## A. 保存力ブランチ（Conservative Branch）追加仕様

### A.1 エネルギー集約（ダブルカウント禁止）

保存ポテンシャルは「無向ペア」単位で 1 回だけ計算し、全体ポテンシャル U は次で定義する：

- 無向ペア集合：P = { {i,j} | i < j, (i,j) が近傍関係 }
- ペアポテンシャル：U_pair(i,j)（スカラー）
- 全体ポテンシャル：
  U = Σ\_{ {i,j}∈P } U_pair(i,j)

注意：

- 有向両方向エッジ E を保持していても、U の和は必ず「ペアで 1 回」に統一する。
- 例外として、両方向で U*ij を計算する実装を採用する場合は、
  U = 0.5 \* Σ*{(i,j)∈E} U_ij とし、ダブルカウントを補正する。

### A.2 内部相互作用の入力制約（相対量のみ）

保存枝が内部相互作用（internal interaction）として振る舞うことを担保するため、
保存枝の入力特徴は原則として「相対量・局所量」のみで構成する。

- 許可する代表例：

  - r_ij = x_i - x_j、dist = ||r_ij||、dist/h（無次元距離）
  - m_i, m_j
  - rho_i, rho_j（※SPH 特徴が利用可能な場合のみ）
  - type_i, type_j（埋め込み）
  - W_ij, |∇W_ij|（※SPH 特徴が利用可能な場合のみ）

- 原則禁止：
  - x_i（絶対座標）や x_j（絶対座標）をそのまま入力に入れること
  - グローバル座標系に依存する特徴（内部相互作用では外場化するため）

例外（外場・境界として扱う場合）：

- 壁ポテンシャル U_wall(d_i) など「外部場」として明示的に扱う場合に限り、
  壁距離 d_i 等の外場由来特徴を入力に使用してよい。
  （この場合も保存枝の “内部相互作用” 部分とは区別する）

### A.3 近傍集合の扱い（E 固定の勾配）

近傍グラフの構築（radius_graph / kNN）は離散処理であり、
近傍集合の変化（エッジの出入り）に対して微分は行わない。

- 勾配計算は、各 forward において得られた近傍集合 P（または E）を固定し、
  U(x; P 固定) に対してのみ行う。
- すなわち、近傍の出入りに由来する勾配は無視する（仕様上の割り切り）。

---

## B. 自動微分による力・加速度算出（実装要件）追加仕様

### B.1 U は必ずスカラーに集約してから勾配を取る

自動微分で ∂U/∂x を計算するため、U は必ずスカラーに集約する：

- U = Σ U_pair（shape: []）
- grad_x = ∂U/∂x（shape: (N, d)）

### B.2 計算グラフ切断の禁止（detach/no_grad 禁止）

保存枝で勾配を得るには、x →（特徴量）→ U の計算グラフが連結である必要がある。
よって保存枝に関わる特徴量計算において、以下を禁止する：

- dist, r_ij, dist/h 等を生成する際に .detach() を挟むこと
- 保存枝の特徴量計算を with torch.no_grad(): 下で行うこと
- x を途中で detach したテンソルに置換すること

（これらは ∂U/∂x を 0 または None にし、保存枝が機能しなくなる）

### B.3 勾配計算の実装要件

保存枝の forward では以下を満たすこと：

- x*t.requires_grad*(True)
- U をスカラーとして構成
- grad_x = autograd.grad(U, x_t, create_graph=CREATE_GRAPH)[0]
- a_cons = -grad_x / m

CREATE_GRAPH の扱い：

- 保存枝ネットワークのパラメータまで学習信号を流す必要がある学習設定では
  create_graph=True を使用する。
- 設定により create_graph=False でも成立する場合があるが、既定値は True を推奨。

### B.4 境界粒子を用いる場合の勾配対象

壁粒子をノードとして導入する場合、固定壁であれば：

- x*wall.requires_grad*(False)（固定）
- 流体粒子 x_fluid に対してのみ ∂U/∂x_fluid を計算する

壁が可動（剛体連成）である場合は v1.0 のスコープ外とし、別途拡張仕様で定義する。

---

## C. SPH 特徴量の段階導入（任意機能として明記）

本モデルは SPH 特徴量の有無を切替可能な 2 モードを公式にサポートする：

- Mode A（最小 GNS 特徴・既定）：

  - 保存枝：dist/h, m_i,m_j, type（相対量中心）
  - 散逸枝：dist/h, v_ij（必要なら rhat）
  - rho, W, ∇W は使用しない

- Mode B（SPH 拡張・任意）：
  - Mode A に加えて rho_i, rho_j, W_ij, |∇W_ij| 等を追加できる
  - ただし保存枝の「相対量中心」の原則は維持する（絶対座標は入れない）

---

## D. Acceptance Criteria（追加）

- U の集約は「ペアで 1 回（i<j）」または「0.5 \* 両方向和」で実装されている
- 保存枝の入力に x_i（絶対座標）が直接含まれていない（外場・境界を除く）
- 勾配計算は E/P 固定の U(x; P 固定) に対して行われることが明記されている
- 保存枝に関わる特徴量生成で detach / no_grad により計算グラフが切断されていない
