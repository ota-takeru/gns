*モデル設計 仕様書*

題名：SPH特徴量＋学習ポテンシャルによる保存力 + 別枝の散逸  
（Conservative + Dissipative Decomposition for Particle Fluids）  
版：v1.0（2025-12-18）  
目的：粒子系流体の加速度を「保存力（勾配力）＋散逸（速度依存）」に構造分解し、説明可能性・安定性・外挿性を高める。

---

## 1. スコープ

### 1.1 対象
- 粒子法流体（SPH系のデータ・近傍構造が利用可能なもの）
- 2D/3D対応（次元 d∈{2,3} はハイパーパラメータ）

### 1.2 非対象（v1.0では仕様外）
- 圧縮性/非圧縮性の厳密なPDE整合を保証するソルバ置換（本モデルはデータ駆動の近似）
- 自由表面・剛体連成の完全統合（拡張点としては許容）

---

## 2. 設計方針

- **保存力（conservative）**は必ずスカラーのポテンシャル $U$ から $-\nabla U$ で生成する。
- **散逸（dissipative）**は速度依存（例：相対速度）を入力に持つ別ブランチで生成する。
- SPHは “加速度出力”を使わず、密度やカーネル勾配などの中間量を特徴量として使用する。
- 近傍和（message passing + sum aggregation）を基本にし、粒子数変化に対してスケールしやすい構造を採用する。

---

## 3. 入出力仕様

### 3.1 入力（時刻 t）
- 粒子数 $N$、次元 $d$、近傍エッジ数 $E$
- 必須（node）  
	- 位置：$x_t$ 形状 $(N, d)$  
	- 速度：$v_t$ 形状 $(N, d)$  
	- 質量：$m$ 形状 $(N, 1)$（一定ならスカラーでも可）  
	- 粒子タイプ：type 形状 $(N,)$（流体/境界など。無いなら省略可）
- 任意（外部）  
	- 重力等：$a_{ext}$ 形状 $(N, d)$（既知項）

### 3.2 近傍グラフ
- 半径グラフ $radius\_graph(x_t, r)$ もしくは kNN
- エッジ $(i, j)$ は「$j\to i$ へメッセージ」の向きで保持（両方向エッジ推奨）

### 3.3 出力
- 加速度：$\hat{a}$ 形状 $(N, d)$  
	$\hat{a} = a_{cons} + a_{diss} + a_{ext}$  
- 次状態は積分器で算出（モデル自体は $\hat{a}$ を主出力とするのが標準）

---

## 4. SPH特徴量生成（Feature Builder）

### 4.1 カーネル
- 仕様：cubic spline / wendland 等（選択可能）
- サポート半径：$h$（スムージング長）
- 近傍半径：$r = k \cdot h$（例：$k=2$）

### 4.2 生成する中間量
- 密度  
	$\rho_i = \sum_{j\in N(i)} m_j W(r_{ij}, h)$  
	出力：rho 形状 $(N, 1)$
- カーネル勾配（エッジ）  
	$\nabla W_{ij} = \nabla_{x_i} W(\|x_i - x_j\|, h)$  
	出力：gradW 形状 $(E, d)$
- 基本幾何（エッジ）  
	- 相対位置：$r_{ij} = x_i - x_j$ 形状 $(E, d)$  
	- 距離：$dist = \|r_{ij}\|$ 形状 $(E, 1)$  
	- 正規化方向：$rhat = r_{ij} / (dist + \epsilon)$ 形状 $(E, d)$
- 速度差（エッジ）  
	$v_{ij} = v_i - v_j$ 形状 $(E, d)$

---

## 5. 保存力ブランチ（Conservative Branch）

### 5.1 目的
- 保存力を「ポテンシャルの勾配」として生成し、保存力らしさ（勾配場）を構造で担保する。

### 5.2 モデル出力
- エッジ・ポテンシャル $U_{ij}$（スカラー） 形状 $(E, 1)$
- 全ポテンシャル：$U = \sum_{(i,j)\in E} U_{ij}$

### 5.3 入力特徴（推奨）
- $edge\_feat\_cons(i,j)$ に以下を含める（最低限から順）
	- $dist/h$（無次元距離）
	- $\rho_i, \rho_j$（密度）
	- $m_i, m_j$
	- $W_{ij}$ または $|\nabla W_{ij}|$（任意）
	- 粒子タイプ埋め込み（任意）
- 保存力枝には原則 速度 を入れない（分離を構造で固定）

### 5.4 対称化仕様（必須推奨）
- 保存力を内部相互作用として整えるため、$U_{ij} = U_{ji}$ を満たす仕組みを入れる  
	- A：無向エッジ集合を作り、ペアに対して1回だけ $U_{pair}$ を計算し両方向に共有  
	- B：両方向計算して $U_{sym} = 0.5(U_{ij} + U_{ji})$ を使用

### 5.5 力・加速度算出（必須）
- 自動微分で勾配を計算：  
	$F_i^{cons} = -\frac{\partial U}{\partial x_i},\quad a_i^{cons} = F_i^{cons}/m_i$  
- 実装要件：`x_t.requires_grad_(True)` が必要

---

## 6. 散逸ブランチ（Dissipative Branch）

### 6.1 目的
- 粘性・摩擦などの速度依存の減衰を表現し、保存力と役割が混線しないようにする。

### 6.2 モデル出力
- $a_{diss}$ 形状 $(N, d)$（直接加速度として出す）

### 6.3 入力特徴（推奨）
- $edge\_feat\_diss(i,j)$：
	- $dist/h$
	- $v_{ij}$（必須）
	- $rhat$（任意：方向性を使う）
	- $\rho_i, \rho_j$（任意）
- $node\_feat\_diss(i)$：
	- $\rho_i$
	- $|v_i|$（任意）

### 6.4 安定化の制約（推奨）
- 投影型：相対速度方向へ抵抗  
	$a_{ij}^{diss} = -\alpha_{ij} (v_{ij} \cdot rhat_{ij}) rhat_{ij}$  
	NNは $\alpha_{ij} \geq 0$ を出す（softplus等で非負化）
- ゲーティング型：$a_{diss} = gate \times raw$（$gate \geq 0$）

---

## 7. 境界・外力

### 7.1 外力
- 重力等は $a_{ext}$ として既知加算（標準）

### 7.2 境界（2案、どちらか採用）
- 案1：境界ポテンシャル（保存力側で処理しやすい）  
	$U += \sum_i U_{wall}(d_i)$（$d_i$: 壁距離）
- 案2：境界特徴を入力  
	$dist\_to\_wall$ を node/edge feature として両枝へ供給

---

## 8. 時間積分（Integrator）

### 8.1 仕様
- 入力：$x_t, v_t, \hat{a}, dt$
- 出力：$x_{t+1}, v_{t+1}$

### 8.2 推奨
- Semi-implicit Euler（安定寄り）  
	$v_{t+1} = v_t + dt \cdot \hat{a}$  
	$x_{t+1} = x_t + dt \cdot v_{t+1}$
- もしくは Verlet / symplectic 系（長期安定性が欲しい場合）

---

## 9. 学習仕様

### 9.1 教師信号
- 既存GNS互換なら「次ステップ速度」または「加速度」  
	$a_{gt} = (v_{t+1} - v_t)/dt$  
	あるいは $v_{t+1}$ 直接

### 9.2 損失関数（標準）
- $L = MSE(\hat{a}, a_{gt})$ または $MSE(\hat{v}_{t+1}, v_{gt, t+1})$

### 9.3 正則化（任意）
- $|a_{diss}|$ のL2（過剰散逸抑制）
- エネルギー整合の補助（保存枝の暴れ抑制）

---

## 10. 実装インタフェース（推奨API）

### 10.1 モジュール分割
- NeighborBuilder：近傍グラフ生成
- SPHFeatureBuilder：rho, gradW, ... 生成
- ConservativePotentialNet：$U_{ij}$ 予測（GNN）
- DissipativeAccelNet：$a_{diss}$ 予測（GNN/MLP）
- Integrator：時間積分

### 10.2 forward の契約
- `forward(x_t, v_t, m, type, dt, boundary_info=None, a_ext=None) -> (a_hat, aux)`
- aux には $U$, $a_{cons}$, $a_{diss}$, $rho$ 等を格納（デバッグ・可視化用）

---

## 11. 期待される性質（仕様として主張する点）

- 保存力が勾配由来（$-\nabla U$）であることを構造で保証
- 散逸が速度依存であることを構造で保証
- SPHの知見（局所密度・近傍幾何）を入力に取り込み、学習の安定性を上げる
- 近傍和（sum aggregation）により粒子数変化・局所密度変化に対して拡張しやすい

---

## 12. 受け入れ基準（Acceptance Criteria）

- $a_{cons}$ は $U$ の勾配から生成されている（コード上の保証）
- 保存枝に速度が入っていない（設定でON/OFF可能でも、デフォルトOFF）
- 学習が発散せず、短期ロールアウトがベースライン（素GNS）と同等以上
- アブレーションで分離の意味が示せる
- 保存枝のみ / 散逸枝のみ / 両方 の比較が可能
