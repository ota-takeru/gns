mode: train # train / valid / rollout
data_path: ./datasets/out/ # train.npz / valid.npz / test.npz を置くディレクトリ
scenario: fluid
scenario_options:
  rigid:
    dataset: ./datasets/out
    description: Default planar rigid-body scenes
  fluid:
    dataset: ./datasets/out_fluid/dam_break_left
    rollout_dataset: valid
    description: PySPH-based dam break fluid dataset
method: hamiltonian_sph
method_options:
  hamiltonian_sph:
    particle_mass: null # 未指定ならメタデータから自動推定
    sph:
      # 粒子間隔0.12・rc≈0.32（=2*h）の想定で近傍数を ~20 に増やす
      smoothing_length: 0.16 # 2*h がカットオフ半径（約0.32）
      max_num_neighbors: 128
    conservative:
      mlp_layers: 2
      mlp_hidden_dim: 128
      dropout: 0.0
      phi_max_multiplier: 2.0
      use_density: false
    dissipation:
      mlp_layers: 2
      mlp_hidden_dim: 128
      dropout: 0.0
      alpha_max: 1.0
      s_clip_scaled: 5.0
    wall:
      enabled: false # 壁MLP項を無効化（壁由来の加速度をオフ）
    wall_particles:
      enabled: true
      particle_type_id: 3
      freeze_walls: true
      zero_wall_acceleration: true
      disable_wall_mlp: true
      disable_rollout_reflection: true
    cutoff:
      kind: cosine
    integrator:
      dt: 0.006
      type: leapfrog # leapfrog|symplectic_euler
    gravity: [0.0, -9.81] # 2D データセットに合わせる
    include_external_acceleration: true
    pos_feature_scale: null # null で半径を使用
    vel_feature_scale: null # null で pos_feature_scale/dt
model_path: ./models/ # モデルやtrain_stateの保存先
output_path: ./rollouts/
output_filename: rollout

batch_size: 40
noise_std: 0.0
noise: random_walk # ノイズ生成の種類（デフォルト従来挙動）
loss: acceleration # ロス関数（デフォルト従来挙動）

# トレーニング
ntraining_steps: 1000000
validation_interval: 10000 # 例: 10000 にするとステップごとに簡易valid
nsave_steps: 50000
rollout_interval: 20000 # ロールアウト計測を無効化する場合は null
rollout_max_examples: 1 # ロールアウト評価に使うシーン数
rollout_dataset: null # null なら valid/test/train の順で自動選択
train_dataset_fraction: null # 0-1 で学習データを間引く(nullで全量)
valid_dataset_fraction: null # 0-1 で検証データを間引く(nullで全量)
train_dataset_count: null # 学習データの使用件数を直接指定(nullで制限なし)
valid_dataset_count: null # 検証データの使用件数を直接指定(nullで制限なし)
tensorboard_enable: false # TensorBoard ロギングを有効化するか（デフォルト無効）
tensorboard_log_dir: null # null の場合は model_path/tb
log_interval: 500 # 学習ログを出力するステップ間隔
tensorboard_interval: 100 # TensorBoard に書き込むステップ間隔（null で log_interval と同じ）
tensorboard_port: null # 自動割当
tensorboard_host: null # 省略時は 127.0.0.1
max_grad_norm: 1.0
warmup_steps: 2000

# 学習率（指数減衰）
lr_init: 0.00003
lr_decay: 0.1
lr_decay_steps: 5000000

# 再開関連（"latest" で自動復帰 / null なら新規）
model_file: null
train_state_file: null

# GPU選択（null で自動）
cuda_device_number: null
seed: 42
enable_ddp: true
ddp_backend: nccl
ddp_timeout_sec: 1800
# 使われていないパラメータを探すかどうか（デフォルト: true）
ddp_find_unused_parameters: true
amp_enable: true
amp_dtype: float16
gradient_accumulation_steps: 1
num_workers: 4
persistent_workers: true
pin_memory: true
prefetch_factor: 4
